#!/usr/bin/env python
from tilde import runner
from tilde import loader
import time

import traceback
import optparse
import logging


opt = optparse.OptionParser()
opt.set_default("loglevel", logging.WARN)
opt.add_option("-c", "--config", dest="cfgfile", default="/etc/tilde/tilde.ini")
opt.add_option("-v", action="store_const", dest="loglevel", const=logging.INFO)
opt.add_option("-d", action="store_const", dest="loglevel", const=logging.DEBUG)
opt.add_option("-q", action="store_const", dest="loglevel", const=logging.ERROR)
opt.add_option("-1", action="store_true", dest="once")


opts, args = opt.parse_args()
logging.basicConfig(level=opts.loglevel)
while True:
    sleeptime = 60
    try:
        cfg = loader.load_config(opts.cfgfile)
        sleeptime = cfg['sleeptime']

        for srv in cfg['servers'].values():
            runner.run(cfg['dburl'],
                       srv['name'],
                       srv['root'],
                       srv.get('archive_root')
                      )

    except KeyboardInterrupt:
        break
    except Exception, e:
        traceback.print_exc()
        import pdb
        pdb.post_mortem()

    if opts.once:
        break

    time.sleep(sleeptime)
